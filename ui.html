<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<style>
  * { box-sizing: border-box; }
  body { font-family: Inter, -apple-system, sans-serif; padding: 12px; width: 360px; background: #fff; color: #1a1a1a; }
  .section { margin-bottom: 12px; }
  label { display: block; font-size: 11px; font-weight: 600; margin-bottom: 4px; color: #444; text-transform: uppercase; letter-spacing: 0.4px; }
  input[type="text"] { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; }
  input[type="text"]:focus { border-color: #0066cc; outline: none; }
  textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; height: 44px; resize: vertical; }
  .upload-area { border: 2px dashed #ccc; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; color: #888; font-size: 12px; transition: all 0.2s; }
  .upload-area:hover { border-color: #0066cc; color: #0066cc; }
  .upload-area.active { border-color: #4caf50; background: #f0fff4; color: #2e7d32; }
  .upload-area input[type="file"] { display: none; }
  .btn-primary { display: block; width: 100%; padding: 10px; background: #0066cc; color: #fff; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
  .btn-primary:hover { background: #0055aa; }
  .btn-primary:disabled { background: #b0b0b0; cursor: not-allowed; }
  .btn-secondary { display: block; width: 100%; padding: 8px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; cursor: pointer; }
  .btn-secondary:hover { background: #e4e4e4; }
  .status { font-size: 11px; color: #666; margin-top: 4px; }
  .status.ok { color: #2e7d32; font-weight: 600; }
  .error { color: #d32f2f; font-size: 11px; margin-top: 6px; min-height: 14px; }
  .specs-box { background: #f7f7f7; border-radius: 6px; padding: 8px 10px; margin-top: 6px; font-size: 11px; line-height: 1.6; }
  .specs-box .val { font-weight: 600; color: #1a1a1a; }
  .divider { border: none; border-top: 1px solid #eee; margin: 12px 0; }
  .hint { font-size: 10px; color: #999; margin-top: 4px; font-style: italic; }
</style>
</head>
<body>

<div class="section">
  <label>Replicate API Key</label>
  <input type="text" id="apiKey" placeholder="Enter your token..." />
</div>

<hr class="divider">

<div class="section">
  <label>1. Мастер-макет из Figma</label>
  <p class="hint">Выделите артборд "master" в Figma, затем нажмите кнопку</p>
  <button class="btn-secondary" id="loadMasterBtn">Загрузить мастер</button>
  <div class="status" id="masterStatus"></div>
</div>

<div class="section" id="masterScreenshotSection">
  <label>Скриншот мастера (для анализа layout)</label>
  <label class="upload-area" id="screenshotUploadArea">
    Загрузить скриншот мастера
    <input type="file" id="screenshotInput" accept="image/*" />
  </label>
  <div class="status" id="layoutStatus"></div>
</div>

<hr class="divider">

<div class="section">
  <label>2. Технические условия (ТТ)</label>
  <label class="upload-area" id="ttUploadArea">
    Загрузить изображение ТТ
    <input type="file" id="ttInput" accept="image/*" />
  </label>
  <button class="btn-secondary" id="ttFromFigmaBtn" style="margin-top:8px;">Выбрать ТТ из Figma</button>
  <div class="status" id="ttFromFigmaStatus"></div>
  <div id="specsBox" class="specs-box" style="display:none;"></div>
</div>

<hr class="divider">

<div class="section" id="textSection" style="display:none;">
  <label>3. Текст (из мастера, можно редактировать)</label>
  <label style="font-size:11px;color:#666;font-weight:400;margin-bottom:2px;text-transform:none;">Лайн</label>
  <textarea id="headlineInput"></textarea>
  <label style="font-size:11px;color:#666;font-weight:400;margin-bottom:2px;text-transform:none;margin-top:8px;">Саблайн</label>
  <textarea id="sublineInput"></textarea>
  <label style="font-size:11px;color:#666;font-weight:400;margin-bottom:2px;text-transform:none;margin-top:8px;">Дисклеймер</label>
  <textarea id="disclaimerInput"></textarea>
</div>

<hr class="divider">

<div class="section">
  <button class="btn-primary" id="generateBtn" disabled>Сгенерировать макет</button>
  <div class="error" id="errorMsg"></div>
</div>

<script>
"use strict";
(() => {
  // ui.ts
  console.log("[DEBUG UI] ui.ts script loaded at", Date.now());
  var apiKeyInput = document.getElementById("apiKey");
  var loadMasterBtn = document.getElementById("loadMasterBtn");
  var masterStatus = document.getElementById("masterStatus");
  var screenshotInput = document.getElementById("screenshotInput");
  var screenshotUploadArea = document.getElementById("screenshotUploadArea");
  var layoutStatus = document.getElementById("layoutStatus");
  var ttInput = document.getElementById("ttInput");
  var ttUploadArea = document.getElementById("ttUploadArea");
  var ttFromFigmaBtn = document.getElementById("ttFromFigmaBtn");
  var ttFromFigmaStatus = document.getElementById("ttFromFigmaStatus");
  var specsBox = document.getElementById("specsBox");
  var textSection = document.getElementById("textSection");
  var headlineInput = document.getElementById("headlineInput");
  var sublineInput = document.getElementById("sublineInput");
  var disclaimerInput = document.getElementById("disclaimerInput");
  var generateBtn = document.getElementById("generateBtn");
  var errorMsg = document.getElementById("errorMsg");
  var masterLoaded = false;
  var parsedSpecs = null;
  var layoutAnalysis = null;
  var REPLICATE_BASE = "https://api.replicate.com/v1";
  function getApiKey() {
    return apiKeyInput.value.trim();
  }
  function usingProxy() {
    return !REPLICATE_BASE.includes("api.replicate.com");
  }
  async function replicateUpload(blob) {
    const fd = new FormData();
    fd.append("content", blob);
    const res = await fetch(`${REPLICATE_BASE}/files`, {
      method: "POST",
      headers: usingProxy() ? {} : { Authorization: `Token ${getApiKey()}` },
      body: fd
    });
    return (await res.json()).urls.get;
  }
  async function replicatePoll(id) {
    while (true) {
      const res = await fetch(`${REPLICATE_BASE}/predictions/${id}`, {
        headers: usingProxy() ? {} : { Authorization: `Token ${getApiKey()}` }
      });
      const d = await res.json();
      if (d.status === "succeeded")
        return d.output;
      if (d.status === "failed")
        throw new Error(d.error || "Prediction failed");
      await new Promise((r) => setTimeout(r, 1500));
    }
  }
  async function replicateRun(prompt, imageBlob) {
    const url = await replicateUpload(imageBlob);
    const res = await fetch(`${REPLICATE_BASE}/predictions`, {
      method: "POST",
      headers: usingProxy() ? { "Content-Type": "application/json" } : { Authorization: `Token ${getApiKey()}`, "Content-Type": "application/json" },
      body: JSON.stringify({ model: "openai/gpt-4o", input: { prompt, image: url } })
    });
    const pred = await res.json();
    return replicatePoll(pred.id);
  }
  function cleanJson(raw) {
    return JSON.parse(raw.replace(/```json\n?/g, "").replace(/```/g, "").trim());
  }
  var PARSE_PROMPT = `You are a parser for outdoor advertising technical specifications.
From the provided image extract parameters and return ONLY valid JSON, no text, no markdown, no code blocks:
{"name":"string","total_width_cm":number,"total_height_cm":number,"text_zone_width_cm":number|null,"text_zone_height_cm":number|null,"has_frame":boolean,"dpi":number,"color_mode":"CMYK"|"RGB","output_format":"string","notes":"string|null}
If a parameter cannot be determined set it to null.`;
  var LAYOUT_PROMPT = `You are an advertising layout analyst.
Look at this outdoor advertising banner image and determine the layout structure.
Return ONLY valid JSON:
{"photo_zone":"left"|"right"|"full","text_zone":"left"|"right"|"none","photo_x":number 0-1,"photo_y":number 0-1,"photo_scale":number >=1,"split_ratio":number 0-1}
photo_x/y = center of photo position (0.5=center). split_ratio = fraction of width for photo.
Full background = photo_zone "full", split_ratio 1.0`;
  loadMasterBtn.addEventListener("click", () => {
    parent.postMessage({ pluginMessage: { type: "READ_MASTER" } }, "*");
    masterStatus.textContent = "\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043C\u0430\u0441\u0442\u0435\u0440\u0430...";
    masterStatus.className = "status";
  });
  screenshotInput.addEventListener("change", async () => {
    const file = screenshotInput.files?.[0];
    if (!file)
      return;
    screenshotUploadArea.classList.add("active");
    screenshotUploadArea.textContent = "\u2713 " + file.name;
    if (!usingProxy() && !getApiKey()) {
      showError("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 API Key");
      return;
    }
    layoutStatus.textContent = "\u0410\u043D\u0430\u043B\u0438\u0437 layout...";
    showError("");
    try {
      const raw = await replicateRun(LAYOUT_PROMPT, file);
      layoutAnalysis = cleanJson(raw);
      layoutStatus.textContent = `\u2713 Layout: \u0444\u043E\u0442\u043E ${layoutAnalysis.photo_zone}, \u0442\u0435\u043A\u0441\u0442 ${layoutAnalysis.text_zone}, split ${layoutAnalysis.split_ratio}`;
      layoutStatus.className = "status ok";
      checkReady();
    } catch (e) {
      showError("\u041E\u0448\u0438\u0431\u043A\u0430 \u0430\u043D\u0430\u043B\u0438\u0437\u0430 layout: " + e.message);
    }
  });
  ttInput.addEventListener("change", async () => {
    const file = ttInput.files?.[0];
    if (!file)
      return;
    ttUploadArea.classList.add("active");
    ttUploadArea.textContent = "\u2713 " + file.name;
    if (!usingProxy() && !getApiKey()) {
      showError("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 API Key");
      return;
    }
    specsBox.style.display = "block";
    specsBox.innerHTML = "\u041F\u0430\u0440\u0441\u0438\u043D\u0433 \u0422\u0422...";
    showError("");
    try {
      parsedSpecs = await parseSpecsFromBlob(file);
      specsBox.innerHTML = renderSpecs(parsedSpecs);
      checkReady();
    } catch (e) {
      showError("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 \u0422\u0422: " + e.message);
    }
  });
  ttFromFigmaBtn.addEventListener("click", () => {
    if (!usingProxy() && !getApiKey()) {
      showError("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 API Key");
      return;
    }
    ttFromFigmaStatus.textContent = "\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0422\u0422 \u0438\u0437 Figma...";
    ttFromFigmaStatus.className = "status";
    showError("");
    parent.postMessage({ pluginMessage: { type: "READ_TT_IMAGE" } }, "*");
  });
  async function parseSpecsFromBlob(blob) {
    const raw = await replicateRun(PARSE_PROMPT, blob);
    return cleanJson(raw);
  }
  function renderSpecs(specs) {
    return `
      <div><strong>${specs.name || "?"}</strong></div>
      <div>\u0420\u0430\u0437\u043C\u0435\u0440: <span class="val">${specs.total_width_cm} \xD7 ${specs.total_height_cm} \u0441\u043C</span></div>
      <div>\u0422\u0435\u043A\u0441\u0442\u043E\u0432\u043E\u0435 \u043F\u043E\u043B\u0435: <span class="val">${specs.text_zone_width_cm ?? "\u2014"} \xD7 ${specs.text_zone_height_cm ?? "\u2014"} \u0441\u043C</span></div>
      <div>DPI: <span class="val">${specs.dpi}</span> &nbsp; ${specs.color_mode} &nbsp; ${specs.output_format}</div>
      ${specs.has_frame ? "<div>\u2713 \u0420\u0430\u043C\u043A\u0430</div>" : ""}
      ${specs.notes ? `<div style="color:#999">${specs.notes}</div>` : ""}
    `;
  }
  window.onmessage = async (event) => {
    if (!event.data.pluginMessage)
      return;
    const msg = event.data.pluginMessage;
    if (msg.type === "MASTER_LOADED") {
      masterLoaded = true;
      masterStatus.textContent = "\u2713 \u041C\u0430\u0441\u0442\u0435\u0440 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D";
      masterStatus.className = "status ok";
      textSection.style.display = "block";
      headlineInput.value = msg.data.headlineText || "";
      sublineInput.value = msg.data.sublineText || "";
      disclaimerInput.value = msg.data.disclaimerText || "";
      checkReady();
    }
    if (msg.type === "GENERATED") {
      showError("");
      masterStatus.textContent = `\u2713 \u041C\u0430\u043A\u0435\u0442 "${msg.name}" \u0441\u043E\u0437\u0434\u0430\u043D!`;
      masterStatus.className = "status ok";
    }
    if (msg.type === "ERROR") {
      showError(msg.message);
    }
    if (msg.type === "TT_IMAGE_DATA") {
      try {
        ttFromFigmaStatus.textContent = "\u041F\u0430\u0440\u0441\u0438\u043D\u0433 \u0422\u0422...";
        const blob = new Blob([msg.imageBytes]);
        parsedSpecs = await parseSpecsFromBlob(blob);
        specsBox.style.display = "block";
        specsBox.innerHTML = renderSpecs(parsedSpecs);
        ttFromFigmaStatus.textContent = "\u2713 \u0422\u0422 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u0438\u0437 Figma";
        ttFromFigmaStatus.className = "status ok";
        checkReady();
      } catch (e) {
        showError("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 \u0422\u0422: " + e.message);
        ttFromFigmaStatus.textContent = "";
      }
    }
  };
  generateBtn.addEventListener("click", () => {
    if (!parsedSpecs || !masterLoaded)
      return;
    const layout = layoutAnalysis || {
      photo_zone: "right",
      text_zone: "left",
      photo_x: 0.5,
      photo_y: 0.5,
      photo_scale: 1,
      split_ratio: 0.5
    };
    showError("");
    parent.postMessage({
      pluginMessage: {
        type: "GENERATE",
        specs: parsedSpecs,
        layout,
        text: {
          headline: headlineInput.value,
          subline: sublineInput.value,
          disclaimer: disclaimerInput.value
        }
      }
    }, "*");
  });
  function showError(msg) {
    errorMsg.textContent = msg;
  }
  function checkReady() {
    generateBtn.disabled = !(parsedSpecs && masterLoaded);
  }
})();
</script>
</body>
</html>
